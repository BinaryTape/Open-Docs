[//]: # (title: Kotlin Multiplatformプロジェクトの構成を選択する)

既存のプロジェクトにKotlin Multiplatformを追加する場合、または新しいプロジェクトを開始する場合、コードを構造化するにはいくつかの方法があります。通常、1つまたは複数のKotlin Multiplatform共有モジュールを作成し、それらをAndroidアプリやiOSアプリから使用します。

特定のケースに最適なアプローチを選択するには、以下の質問を考慮してください。

*   [Kotlin Multiplatformモジュールによって生成されたiOSフレームワークを、iOSアプリからどのように利用しますか？](#connect-a-kotlin-multiplatform-module-to-an-ios-app)
    直接統合しますか、CocoaPods経由ですか、それともSwift Package Manager (SPM)を使用しますか？
*   [Kotlin Multiplatform共有モジュールは1つですか、それとも複数ありますか？](#module-configurations)
    複数の共有モジュールに対するアンブレラモジュールはどのようなものにするべきですか？
*   [すべてのコードをモノレポに保存しますか、それとも複数の異なるリポジトリに保存しますか？](#repository-configurations)
*   [Kotlin Multiplatformモジュールフレームワークをローカル依存関係として利用しますか、それともリモート依存関係として利用しますか？](#code-sharing-workflow)

これらの質問に答えることで、プロジェクトに最適な構成を選択できます。

## Kotlin MultiplatformモジュールをiOSアプリに接続する

iOSアプリからKotlin Multiplatform共有モジュールを使用するには、まずこの共有モジュールから[iOSフレームワーク](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Concepts/WhatAreFrameworks.html)を生成する必要があります。その後、それをiOSプロジェクトへの依存関係として追加します。

![Kotlin Multiplatform shared module](kmp-shared-module.svg){width=700}

このフレームワークは、ローカル依存関係またはリモート依存関係として利用できます。

Kotlin Multiplatformモジュールフレームワークへの依存関係をiOSプロジェクトに追加するには、以下のいずれかの方法があります。

*   **直接統合**。iOSアプリのビルドに新しい実行スクリプトフェーズを追加することで、フレームワークを直接接続します。Xcodeでの設定方法については、「[フレームワークをiOSプロジェクトに接続する](multiplatform-integrate-in-existing-app.md#configure-the-ios-project-to-use-a-kmp-framework)」を参照してください。

    Android Studioウィザードでプロジェクトを作成する際、「**Regular framework**」オプションを選択すると、この設定が自動的に生成されます。

*   **CocoaPods統合**。[CocoaPods](https://cocoapods.org/)を介してフレームワークを接続します。CocoaPodsは、SwiftおよびObjective-Cプロジェクトで人気の依存関係マネージャーです。これはローカル依存関係またはリモート依存関係のいずれかになります。詳細については、「[Kotlin GradleプロジェクトをCocoaPods依存関係として使用する](multiplatform-cocoapods-xcode.md)」を参照してください。

    ローカルCocoaPods依存関係によるワークフローを設定するには、ウィザードでプロジェクトを生成するか、スクリプトを手動で編集します。

*   **SPMの使用**。Swiftコードの配布を管理するAppleのツールであるSwift Package Manager (SPM)を使用してフレームワークを接続します。私たちは[SPMの公式サポートに取り組んでいます](https://youtrack.jetbrains.com/issue/KT-53877)。現在、XCFrameworksを使用してSwiftパッケージへの依存関係を設定できます。詳細については、「[Swiftパッケージエクスポートのセットアップ](multiplatform-spm-export.md)」を参照してください。

## モジュール構成

Kotlin Multiplatformプロジェクトで使用できるモジュール構成オプションは、シングルモジュールまたは複数の共有モジュールの2つです。

### シングル共有モジュール

最もシンプルなモジュール構成では、プロジェクト内に単一の共有Kotlin Multiplatformモジュールのみが含まれます。

![Single shared module](single-shared-module.svg){width=700}

Androidアプリは通常のKotlinモジュールとしてKotlin Multiplatform共有モジュールに依存できます。ただし、iOSはKotlinを直接使用できないため、iOSアプリはKotlin Multiplatformモジュールによって生成されたiOSフレームワークに依存する必要があります。

<table>
  <tr>
     <th>長所</th>
     <th>短所</th>
  </tr>
  <tr>
  <td>
    <list>
       <li>単一モジュールのみのシンプルな設計は、認知負荷を軽減します。機能をどこに配置するか、論理的に分割する方法について考える必要はありません。</li>
       <li>開始点として最適です。</li>
</list>
</td>
<td>
<list>
  <li>共有モジュールが大きくなるにつれて、コンパイル時間が増加します。</li>
  <li>この設計では、機能を分離したり、アプリが必要とする機能のみに依存したりすることはできません。</li>
</list>
</td>
</tr>
</table>

### 複数の共有モジュール

共有モジュールが大きくなるにつれて、それを機能モジュールに分割することをお勧めします。これにより、単一モジュールに起因するスケーラビリティの問題を回避できます。

Androidアプリは、すべての機能モジュールに直接依存することも、必要に応じて一部の機能モジュールにのみ依存することもできます。

iOSアプリは、Kotlin Multiplatformモジュールによって生成された1つのフレームワークに依存できます。複数のモジュールを使用する場合、使用しているすべてのモジュールに依存する追加のモジュール（_アンブレラモジュール_と呼ばれます）を追加し、その後、すべてのモジュールを含むフレームワーク（_アンブレラフレームワーク_と呼ばれます）を構成する必要があります。

> アンブレラフレームワークバンドルには、プロジェクトのすべての共有モジュールが含まれ、iOSアプリにインポートされます。
>
{style="tip"}

<table>
  <tr>
     <th>長所</th>
     <th>短所</th>
  </tr>
  <tr>
  <td>
    <list>
       <li>共有コードの関心の分離。</li>
       <li>より優れたスケーラビリティ。</li>
       </list>
</td>
<td>
<list>
  <li>アンブレラフレームワークのセットアップを含む、より複雑なセットアップ。</li>
 <li>モジュール間のより複雑な依存関係管理。</li>
</list>
</td>
</tr>
</table>

アンブレラモジュールを設定するには、すべての機能モジュールに依存する別のモジュールを追加し、このモジュールからフレームワークを生成します。

![Umbrella framework](umbrella-framework.svg){width=700}

Androidアプリは、一貫性のためにアンブレラモジュールに依存することも、個別の機能モジュールに依存することもできます。アンブレラモジュールには、しばしば便利なユーティリティ関数や依存性注入のセットアップコードが含まれます。

アンブレラフレームワークには一部のモジュールのみをエクスポートできます。これは通常、フレームワークのアーティファクトがリモート依存関係として利用される場合です。主な理由は、自動生成されたコードが除外されるようにすることで、最終的なアーティファクトのサイズを抑えるためです。

アンブレラフレームワークアプローチの既知の制約として、iOSアプリは一部の機能モジュールのみを使用することができず、それらすべてを自動的に利用します。この機能の改善の可能性については、[KT-42247](https://youtrack.jetbrains.com/issue/KT-42247) および [KT-42250](https://youtrack.jetbrains.com/issue/KT-42250) であなたのケースを記述してください。

> 以下の例でiOSアプリがアンブレラモジュールに依存していると表示されている場合、それはこのモジュールから生成されたアンブレラフレームワークにも依存していることを意味します。
>
{style="tip"}

#### なぜアンブレラフレームワークが必要なのですか？ {initial-collapse-state="collapsed" collapsible="true"}

iOSアプリに異なるKotlin Multiplatform共有モジュールから生成された複数のフレームワークを含めることは可能ですが、このアプローチは推奨されません。Kotlin Multiplatformモジュールがフレームワークにコンパイルされると、結果として生成されるフレームワークにはそのすべての依存関係が含まれます。2つ以上のモジュールが同じ依存関係を使用し、別々のフレームワークとしてiOSに公開される場合、Kotlin/Nativeコンパイラはその依存関係を重複させます。

この重複は、いくつかの問題を引き起こします。第一に、iOSアプリのサイズが不必要に肥大化します。第二に、ある依存関係のコード構造が、重複した依存関係のコード構造と互換性がありません。これは、iOSアプリケーション内で同じ依存関係を持つ2つのモジュールを統合しようとする際に問題を引き起こします。例えば、異なるモジュールが同じ依存関係を介して渡す状態は接続されません。これにより、予期せぬ動作やバグにつながる可能性があります。正確な制限の詳細については、[TouchLabのドキュメント](https://touchlab.co/multiple-kotlin-frameworks-in-application/)を参照してください。

Kotlinは共通のフレームワーク依存関係を生成しません。なぜなら、そうしないと重複が発生し、アプリに追加するKotlinバイナリは可能な限り小さくする必要があるからです。Kotlinランタイム全体とすべての依存関係のコードをすべて含めることは無駄です。Kotlinコンパイラは、特定のビルドに必要なものだけを正確にバイナリからトリミングできます。しかし、他のビルドが必要とするものを知らないため、依存関係を共有しようとすることは現実的ではありません。私たちはこの問題の影響を最小限に抑えるための様々な選択肢を模索しています。

この問題の解決策は、アンブレラフレームワークを使用することです。これにより、iOSアプリの重複した依存関係による肥大化を防ぎ、結果として生成されるアーティファクトの最適化を助け、依存関係間の非互換性によって引き起こされる不満を解消します。

## リポジトリ構成

新規および既存のKotlin Multiplatformプロジェクトで使用できるリポジトリ構成オプションは多数あり、単一のリポジトリまたは複数のリポジトリの組み合わせを使用します。

### モノレポ: すべてを1つのリポジトリに

一般的なリポジトリ構成はモノレポ構成と呼ばれます。このアプローチはKotlin Multiplatformのサンプルやチュートリアルで使用されています。この場合、リポジトリにはAndroidアプリとiOSアプリの両方、および共有モジュールまたは複数のモジュール（アンブレラモジュールを含む）が含まれます。

![Monorepo configuration](monorepo-configuration-1.svg){width=700}

![Monorepo configuration](monorepo-configuration-2.svg){width=700}

通常、iOSアプリはKotlin Multiplatform共有モジュールを直接統合またはCocoaPods統合を使用して、通常のフレームワークとして利用します。詳細およびチュートリアルへのリンクについては、「[Kotlin MultiplatformモジュールをiOSアプリに接続する](#connect-a-kotlin-multiplatform-module-to-an-ios-app)」を参照してください。

リポジトリがバージョン管理下にある場合、アプリと共有モジュールは同じバージョンを持ちます。

<table>
  <tr>
     <th>長所</th>
     <th>短所</th>
  </tr>
  <tr>
  <td>
    <list>
       <li>ウィザードの助けを借りて簡単にセットアップできます。</li>
       <li>すべてのコードが同じリポジトリにあるため、iOS開発者はKotlin Multiplatformコードを簡単に扱えます。</li>
</list>
</td>
<td>
<list>
  <li>iOS開発者は、なじみのないツールをセットアップして構成する必要があります。</li>
<li>このアプローチは、すでに異なるリポジトリに保存されている既存のアプリには適用できないことがよくあります。</li>
</list>
</td>
</tr>
</table>

既存のAndroidアプリとiOSアプリがすでに異なるリポジトリに保存されている場合、それらをマージするのではなく、Kotlin Multiplatform部分をAndroidリポジトリまたは別のリポジトリに追加できます。

### 2つのリポジトリ: Android + 共有 | iOS

もう1つのプロジェクト構成は、2つのリポジトリを持つことです。この場合、Kotlin MultiplatformリポジトリにはAndroidアプリと共有モジュール（アンブレラモジュールを含む）の両方が含まれ、XcodeプロジェクトにはiOSアプリが含まれます。

![Two repository configuration](two-repositories.svg){width=700}

AndroidアプリとiOSアプリは個別にバージョン管理でき、共有モジュールはAndroidアプリとともにバージョン管理されます。

### 3つのリポジトリ: Android | iOS | 共有

もう1つのオプションは、Kotlin Multiplatformモジュール用に別のリポジトリを持つことです。この場合、AndroidアプリとiOSアプリは別々のリポジトリに保存され、プロジェクトの共有コードには複数の機能モジュールとiOS用のアンブレラモジュールを含めることができます。

![Three repository configuration](three-repositories.svg){width=700}

各プロジェクトは個別にバージョン管理できます。Kotlin Multiplatformモジュールもバージョン管理され、AndroidまたはJVMプラットフォーム向けに公開される必要があります。機能モジュールを個別に公開することも、アンブレラモジュールのみを公開してAndroidアプリがそれに依存するようにすることもできます。

Kotlin MultiplatformモジュールがAndroidプロジェクトの一部であるシナリオと比較して、Androidアーティファクトを個別に公開することは、Android開発者にとって追加の複雑さを伴う可能性があります。

AndroidチームとiOSチームの両方が同じバージョン管理されたアーティファクトを利用する場合、それらはバージョンパリティで動作します。チームの観点からは、これにより共有Kotlin MultiplatformコードがAndroid開発者に「所有されている」という印象を避けることができます。機能開発のためにバージョン管理された内部KotlinおよびSwiftパッケージをすでに公開している大規模なプロジェクトでは、共有Kotlinアーティファクトの公開は既存のワークフローの一部となります。

### 多数のリポジトリ: Android | iOS | 複数のライブラリ

複数のプラットフォーム上の複数のアプリ間で機能を共有する必要がある場合、Kotlin Multiplatformコードを持つ多数のリポジトリを持つことを好むかもしれません。たとえば、製品全体で共通のロギングライブラリを、独自のバージョン管理を持つ別のリポジトリに保存できます。

この場合、複数のKotlin Multiplatformライブラリリポジトリを持つことになります。複数のiOSアプリが「ライブラリプロジェクト」の異なるサブセットを使用する場合、各アプリは、ライブラリプロジェクトへの必要な依存関係を含むアンブレラモジュールを含む追加のリポジトリを持つことができます。

![Many repository configuration](many-repositories.svg){width=700}

ここでは、各ライブラリもAndroidまたはJVMプラットフォーム向けにバージョン管理され、公開される必要があります。アプリと各ライブラリは個別にバージョン管理できます。

## コード共有ワークフロー

iOSアプリは、Kotlin Multiplatform共有モジュールから生成されたフレームワークを_ローカル_または_リモート_依存関係として利用できます。ローカル依存関係は、iOSビルドでフレームワークへのローカルパスを指定することで使用できます。この場合、フレームワークを公開する必要はありません。あるいは、フレームワークを含むアーティファクトをどこかに公開し、iOSアプリがそれを他のサードパーティ依存関係と同様にリモート依存関係として利用するようにすることもできます。

### ローカル: ソース配布

ローカル配布とは、iOSアプリが公開することなくKotlin Multiplatformモジュールフレームワークを利用するケースです。iOSアプリはフレームワークを直接統合するか、CocoaPodsを使用できます。

このワークフローは、通常、AndroidチームとiOSチームの両方のメンバーが共有Kotlin Multiplatformコードを編集したい場合に使用されます。iOS開発者はAndroid Studioをインストールし、KotlinとGradleの基本的な知識が必要です。

ローカル配布スキームでは、iOSアプリのビルドがiOSフレームワークの生成をトリガーします。これは、iOS開発者がKotlin Multiplatformコードへの変更をすぐに確認できることを意味します。

![Local source distribution](local-source-distribution.svg){width=700}

このシナリオは通常、2つのケースで使用されます。第一に、アーティファクトを公開する必要がないデフォルトのワークフローとしてモノレポプロジェクト構成で使用できます。第二に、リモートワークフローに加えて、ローカル開発に使用できます。詳細については、「[ローカル開発のためのローカル依存関係のセットアップ](#setting-up-a-local-dependency-for-local-development)」を参照してください。

このワークフローは、すべてのチームメンバーがプロジェクト全体のコードを編集する準備ができている場合に最も効果的です。共通部分に変更を加えた後、AndroidとiOSの両方の部分が含まれます。理想的には、すべてのチームメンバーがAndroid StudioとXcodeをインストールして、共通コードに変更を加えた後に両方のアプリを開いて実行できるようにします。

<table>
  <tr>
     <th>長所</th>
     <th>短所</th>
  </tr>
  <tr>
  <td>
    <list>
       <li>AndroidとiOSのチームメンバーの両方がKotlin Multiplatformコードを簡単に編集でき、共有コードの作成と保守が共通の責任であることを保証します。これは、チームの孤立を防ぎ、コラボレーションを促進します。</li>
       <li>このアプローチでは、共有コードの個別のバージョン管理と公開は必要ありません。</li>
       <li>iOSチームメンバーはアーティファクトが作成および公開されるのを待つ必要がないため、開発ワークフローが迅速になります。</li>
   </list>
</td>
<td>
  <list>
    <li>チームメンバーは、各自のマシンに完全な開発環境をセットアップする必要があります。</li>
    <li>iOS開発者はAndroid StudioとGradleの使用方法を学ぶ必要があります。</li>
    <li>共有されるコードが増え、チームが大きくなるにつれて、変更管理が困難になります。</li>
  </list>
</td>
</tr>
</table>

### リモート: アーティファクト配布

リモート配布とは、フレームワークアーティファクトがCocoaPodまたはSPMを使用したSwiftパッケージとして公開され、iOSアプリによって利用されることを意味します。Androidアプリは、バイナリ依存関係をローカルまたはリモートで利用できます。

リモート配布は、既存のプロジェクトにテクノロジーを段階的に導入するためによく使用されます。iOS開発者のワークフローやビルドプロセスを大幅に変更することはありません。2つ以上のリポジトリを持つチームは、主にリモート配布を使用してプロジェクトコードを保存します。

まずは、リモート配布ワークフローを大幅に簡素化する一連のビルドツールである[KMMBridge](https://touchlab.co/trykmmbridge)を使用することをお勧めします。あるいは、同様のワークフローを自分でセットアップすることも常に可能です。

![Remote artifact distribution](remote-artifact-distribution.svg){width=700}

<table>
  <tr>
     <th>長所</th>
     <th>短所</th>
  </tr>
  <tr>
  <td>参加しないiOSチームメンバーは、Kotlinでコードを書いたり、Android StudioやGradleのようなツールの使い方を学ぶ必要がありません。これにより、チームへの参入障壁が大幅に低くなります。</td>
<td>
  <list>
    <li>共有コードの編集とビルドのプロセスに公開とバージョン管理が伴うため、iOS開発者にとってワークフローが遅くなります。</li>
   <li>iOSでの共有Kotlinコードのデバッグは困難です。</li>
   <li>iOSチームメンバーが共有コードに貢献する可能性が大幅に低下します。</li>
   <li>共有コードの保守は、参加するチームメンバーに完全に委ねられます。</li>
  </list>
</td>
</tr>
</table>

#### ローカル開発のためのローカル依存関係のセットアップ

多くのチームは、Kotlin Multiplatformテクノロジーを採用する際、iOS開発者にとって開発プロセスを同じに保つためにリモート配布ワークフローを選択します。しかし、このワークフローではKotlin Multiplatformコードを変更するのが困難です。

Kotlin Multiplatformモジュールから生成されたフレームワークへのローカル依存関係を持つ、追加の「ローカル開発」ワークフローを設定することをお勧めします。

開発者が新しい機能を追加する場合、Kotlin Multiplatformモジュールをローカル依存関係として利用するように切り替えます。これにより、共通のKotlinコードに変更を加え、iOSからの動作をすぐに確認し、Kotlinコードをデバッグできます。機能が準備できたら、リモート依存関係に戻し、それに応じて変更を公開できます。まず、共有モジュールに変更を公開し、その後でアプリに変更を加えます。

リモート配布ワークフローには、CocoaPods統合またはSPMのいずれかを使用します。ローカル配布ワークフローには、フレームワークを直接統合します。

<!-- This tutorial [TODO] describes how to switch workflows by choosing the corresponding scheme in Xcode:
[TODO screenshot] -->

CocoaPodsを使用している場合、代わりにCocoaPodsをローカル配布ワークフローに使用することもできます。[TouchLabのドキュメント](https://touchlab.co/kmmbridgecocoapodslocal)に記載されているように、環境変数を変更することで切り替えることができます。