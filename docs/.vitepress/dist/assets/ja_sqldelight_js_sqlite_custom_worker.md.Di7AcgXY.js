import{_ as a,c as i,o as t,ag as n}from"./chunks/framework.Bksy39di.js";const E=JSON.parse('{"title":"カスタムワーカーの実装","description":"","frontmatter":{},"headers":[],"relativePath":"ja/sqldelight/js_sqlite/custom_worker.md","filePath":"ja/sqldelight/js_sqlite/custom_worker.md","lastUpdated":1748435462000}'),e={name:"ja/sqldelight/js_sqlite/custom_worker.md"};function l(h,s,p,k,o,d){return t(),i("div",null,s[0]||(s[0]=[n(`<h1 id="カスタムワーカーの実装" tabindex="-1">カスタムワーカーの実装 <a class="header-anchor" href="#カスタムワーカーの実装" aria-label="Permalink to &quot;カスタムワーカーの実装&quot;">​</a></h1><p>SQLDelightのウェブワーカーは、ウェブワーカー ドライバーから受信メッセージを受け取り、その受信メッセージを使用してSQL操作を実行し、クエリ結果に応じて応答するスクリプトです。</p><p>ウェブワーカーは、比較的短くシンプルなスクリプトであるため、素のJavaScriptで最も簡単に実装できます。</p><h2 id="受信メッセージ" tabindex="-1">受信メッセージ <a class="header-anchor" href="#受信メッセージ" aria-label="Permalink to &quot;受信メッセージ&quot;">​</a></h2><p>ウェブワーカー ドライバーのメッセージフォーマットにより、SQLDelightは特定のSQL方言や実装に縛られない汎用的な方法でワーカー実装と通信できます。すべてのメッセージには、4つのアクションのうちの1つを指定する<code>action</code>プロパティが含まれています。</p><h3 id="exec" tabindex="-1"><code>exec</code> <a class="header-anchor" href="#exec" aria-label="Permalink to &quot;\`exec\`&quot;">​</a></h3><p>このアクションは、ワーカーがメッセージに添付されたSQLステートメントを実行し、そのSQLクエリの結果で応答すべきであることを示します。メッセージには、実行するSQLステートメントを含む<code>sql</code>プロパティと、ステートメントにバインドされるパラメーターを含む<code>params</code>配列が含まれます。</p><p>Example message:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;exec&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;sql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT column_a, column_b FROM some_table WHERE column_a = ?;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;value&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="begin-transaction" tabindex="-1"><code>begin_transaction</code> <a class="header-anchor" href="#begin-transaction" aria-label="Permalink to &quot;\`begin_transaction\`&quot;">​</a></h3><p>ワーカーにトランザクションを開始するよう指示します。</p><p>Example message:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;begin_transaction&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="end-transaction" tabindex="-1"><code>end_transaction</code> <a class="header-anchor" href="#end-transaction" aria-label="Permalink to &quot;\`end_transaction\`&quot;">​</a></h3><p>ワーカーに現在のトランザクションを終了するよう指示します。</p><p>Example message:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;end_transaction&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="rollback-transaction" tabindex="-1"><code>rollback_transaction</code> <a class="header-anchor" href="#rollback-transaction" aria-label="Permalink to &quot;\`rollback_transaction\`&quot;">​</a></h3><p>ワーカーに現在のトランザクションをロールバックするよう指示します。</p><p>Example message:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rollback_transaction&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="メッセージへの応答" tabindex="-1">メッセージへの応答 <a class="header-anchor" href="#メッセージへの応答" aria-label="Permalink to &quot;メッセージへの応答&quot;">​</a></h2><p>すべての受信メッセージには、そのメッセージに固有の一意の整数である<code>id</code>プロパティが含まれています。メッセージに応答する際、ワーカー実装はこの<code>id</code>値を応答メッセージに含める必要があります。これは、ウェブワーカー ドライバーが応答を正しく処理するために使用されます。</p><h3 id="resultsプロパティ" tabindex="-1"><code>results</code>プロパティ <a class="header-anchor" href="#resultsプロパティ" aria-label="Permalink to &quot;\`results\`プロパティ&quot;">​</a></h3><p>応答メッセージには、<code>results</code>プロパティも含まれるべきです。これは、特にクエリの結果セットの場合、SQL実行の結果を伝えるために使用されます。<code>results</code>プロパティは、結果の_行_を表す配列であるべきで、各エントリは結果セット内の_列_を表す配列です。</p><p>For example, a response to the <code>exec</code> message above could be:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;results&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;value&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;this is the content of column_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;value&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;this is a different row&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>結果セットを返さないSQLステートメントの場合、<code>results</code>の値は、ステートメントの実行によって影響を受けた行数を表す数値を含む単一の行/列であるべきです。</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;results&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="例" tabindex="-1">例 <a class="header-anchor" href="#例" aria-label="Permalink to &quot;例&quot;">​</a></h2><ul><li><a href="https://github.com/cashapp/sqldelight/blob/master/drivers/web-worker-driver/sqljs/sqljs.worker.js" target="_blank" rel="noreferrer">SQLDelightのSQL.jsワーカー</a></li></ul>`,31)]))}const c=a(e,[["render",l]]);export{E as __pageData,c as default};
